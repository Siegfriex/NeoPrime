# BigQuery 권한 설정 가이드

## 현재 상황

PowerShell 실행 정책 문제로 스크립트가 자동 실행되지 않습니다. 다음 방법 중 하나를 선택하여 권한을 설정하세요.

---

## 방법 1: PowerShell 실행 정책 변경 후 스크립트 실행 (권장)

### 1단계: 실행 정책 확인
```powershell
Get-ExecutionPolicy
```

### 2단계: 실행 정책 변경 (현재 세션만)
```powershell
Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process
```

### 3단계: 권한 설정 스크립트 실행
```powershell
.\setup_bigquery_permissions.ps1
```

### 4단계: 권한 확인
```powershell
.\check_bigquery_permissions.ps1
```

---

## 방법 2: 직접 명령어 실행 (PowerShell)

### 한 줄씩 실행

```powershell
# 1. 현재 권한 확인
gcloud projects get-iam-policy neoprime0305 --format="table(bindings.role,bindings.members)" --filter="bindings.members:serviceAccount:sa-bq-loader@neoprime0305.iam.gserviceaccount.com"

# 2. BigQuery Job User 역할 추가
gcloud projects add-iam-policy-binding neoprime0305 --member="serviceAccount:sa-bq-loader@neoprime0305.iam.gserviceaccount.com" --role="roles/bigquery.jobUser"

# 3. 권한 확인 (다시)
gcloud projects get-iam-policy neoprime0305 --format="table(bindings.role,bindings.members)" --filter="bindings.members:serviceAccount:sa-bq-loader@neoprime0305.iam.gserviceaccount.com"
```

**주의**: PowerShell에서는 백틱(`` ` ``)을 사용하여 줄바꿈할 수 있습니다:

```powershell
gcloud projects add-iam-policy-binding neoprime0305 `
    --member="serviceAccount:sa-bq-loader@neoprime0305.iam.gserviceaccount.com" `
    --role="roles/bigquery.jobUser"
```

---

## 방법 3: GCP Console에서 설정 (GUI)

1. [GCP Console](https://console.cloud.google.com/) 접속
2. 프로젝트 선택: `neoprime0305`
3. **IAM & Admin** > **IAM** 메뉴 이동
4. 서비스 계정 검색: `sa-bq-loader@neoprime0305.iam.gserviceaccount.com`
5. **편집** 클릭
6. **역할 추가** 클릭
7. 다음 역할 추가:
   - `BigQuery Job User` (필수)
   - `BigQuery Data Editor` (선택사항)
8. **저장** 클릭

---

## 권한 설정 후 확인

### 방법 1: PowerShell 스크립트 사용
```powershell
.\check_bigquery_permissions.ps1
```

### 방법 2: 직접 명령어
```powershell
gcloud projects get-iam-policy neoprime0305 --format="table(bindings.role,bindings.members)" --filter="bindings.members:serviceAccount:sa-bq-loader@neoprime0305.iam.gserviceaccount.com"
```

### 방법 3: Python 테스트 실행
```powershell
# quick_all.ps1로 환경 설정 후
python test_bigquery_actual_load.py
```

---

## 필요한 권한

| 역할 | 필수 여부 | 용도 |
|------|----------|------|
| `roles/bigquery.jobUser` | ✅ 필수 | BigQuery 쿼리 실행, 작업 생성 |
| `roles/bigquery.dataEditor` | ⚠️ 선택 | 데이터 읽기/쓰기 (이미 있을 수 있음) |

---

## 문제 해결

### PowerShell 실행 정책 오류
```
실행 정책으로 인해 이 스크립트를 실행할 수 없습니다.
```

**해결**:
```powershell
Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process
```

### gcloud 명령어를 찾을 수 없음
```
gcloud : 'gcloud' 용어가 cmdlet, 함수, 스크립트 파일로 인식되지 않습니다.
```

**해결**: `quick_all.ps1` 실행하여 환경 변수 설정

### Python을 찾을 수 없음
```
python : 'python' 용어가 cmdlet, 함수, 스크립트 파일로 인식되지 않습니다.
```

**해결**: `quick_all.ps1` 실행하여 Python 경로 설정

---

## 다음 단계

권한 설정 완료 후:

1. **권한 확인**
   ```powershell
   .\check_bigquery_permissions.ps1
   ```

2. **BigQuery 테스트 실행**
   ```powershell
   python test_bigquery_actual_load.py
   ```

3. **전체 파이프라인 실행**
   ```powershell
   python master_pipeline.py --config config.yaml
   ```

---

**생성된 파일**:
- `setup_bigquery_permissions.ps1` - 권한 설정 스크립트
- `check_bigquery_permissions.ps1` - 권한 확인 스크립트
- `권한_설정_가이드.md` - 이 가이드 문서
