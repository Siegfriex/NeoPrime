# THEORY ENGINE 원안 검토·검증 및 미식별 갭 분석 / 디벨롭안 (v1.0)

- **범위**: `theory_engine/` (Theory Engine v3.0) 한정
- **문서 버전**: v1.0
- **최종 업데이트**: 2026-01-21 17:04:29 (KST)
- **검증 상태**: ✅ 1차 검증 완료 (코드/테스트/데이터 축 확인)
- **엔진 버전**: 3.0.0
- **엑셀 버전**: 202511_가채점_20251114
- **실행 환경**: Windows-11-10.0.26200-SP0 / Python 3.13.6

---

## 1) 결론: “적절한가?”

**부분적으로 적절했으나, ‘치명적인 의미론 갭’이 숨어 있었습니다.**

- **적절했던 점(원안 장점)**  
  - RAWSCORE 과목 매칭/INDEX 폴백/전공·대학명 Alias 확장/통합 테스트 강화라는 “문제 표면”은 잘 짚었습니다.
- **치명적 갭(원안이 놓친 핵심)**  
  - PERCENTAGE 축(%)의 방향(0→상위, 값↑→하위)과 커트라인 레벨(적정/예상/소신)의 매핑이 **역전**되어, 커트라인 점수와 확률/레벨 판단이 **구조적으로 왜곡**될 수 있었습니다.

> 이번 분석에서는 해당 갭을 **실데이터로 검증**했고, **코드+테스트로 즉시 수정**했습니다(아래 2~4절).

---

## 2) 검증 방법(재현 가능)

### 사용 도구/명령

- **전체 테스트**
  - `python -m pytest tests/ -q`
  - 결과: **51 passed in 226.38s**

- **PERCENTAGE 축 방향/범위 확인**
  - PERCENTAGE 첫 컬럼명: `%`
  - 값 범위: **~0.00 → 94.0**
  - 관측: `%`가 증가할수록 점수는 감소(상위권일수록 %가 작음)

- **의예/의학 컬럼 존재 확인**
  - **‘의예’ 포함 컬럼: 0개**
  - **‘의학’ 포함 컬럼: 62개**

---

## 3) 미식별 갭(위험요인) — 우선순위/근거/영향

### Critical #1 — PERCENTAGE 커트라인 레벨 매핑 역전 (✅ 수정 완료)

- **증상**: 커트라인이 “적정 < 예상 < 소신”처럼 역전되어, **합격 확률/레벨이 과대평가**될 수 있음  
- **근거(실데이터)**: 예시 “가천의학 이과”
  - (수정 전) 적정(80%)=49.9 / 예상(50%)=73.13 / 소신(20%)=88.28  → **역전**
  - (수정 후) 적정(20%)=88.28 / 예상(50%)=73.13 / 소신(80%)=49.9  → **정상**
- **원인(코드)**: `CutoffExtractor.CUTOFF_PERCENTILES`가 `%`축 의미를 반대로 가정  
- **조치(코드/테스트)**:
  - `CUTOFF_PERCENTILES`: **20/50/80**으로 수정(상위% 기준)
  - 단위 테스트에 **(적정≥예상≥소신)** sanity check 추가

### Critical #2 — 대학 Alias 오매핑(과도한 부분 매칭 + 정규화 불일치) (✅ 수정 완료)

- **증상**: 미등록 대학이 “부분 포함”으로 SKY로 오매핑 가능  
  - 예: `"서울과기대" → "서울대"` (이전 동작에서 확인됨)
  - 괄호/특수문자 포함 캠퍼스 표기 `"연세대(원주)"`가 `"연세대"`로 축약될 수 있음
- **원인(코드)**:
  - Alias 역매핑 키가 정규화되지 않은 상태에서, 입력만 정규화해 “정확 매칭”이 잘 안 되고  
  - 그 다음 “부분 매칭”으로 빠지며 오매핑을 유발
- **조치(코드/테스트)**:
  - 역매핑 키를 `_normalize_university()`로 **정규화 저장**
  - “부분 매칭” 제거(오매핑 방지)
  - 테스트에 **오매핑 방지/괄호 표기 매핑** sanity 추가

---

## 4) 원안(플랜) 구현물에 대한 검수 결과

### 원안 Task별 평가

- **Task 1: 컬럼 오매칭 수정**
  - “대학명만 매칭” 방지 방향은 적절
  - 다만 **퍼지(rapidfuzz) 단계가 전공 Alias보다 먼저 실행되면** 다시 오매칭이 생길 수 있어, 현재는 **전공 Alias를 퍼지보다 우선**하도록 보강함

- **Task 2: 전공명 매핑 시스템**
  - MAJOR_ALIASES 자체는 유효
  - 실데이터에 “의예” 컬럼이 0개이므로, “의예→의학” 매핑은 **기능상 필수**
  - 다만 컬럼 자체가 “관동의 학”처럼 깨진 표기도 존재 → 단순 `in` 문자열 포함으로는 누락될 수 있어, 현재는 **정규화 비교 기반**으로 보강함

- **Task 3: SubjectMatcher 확장**
  - 제2외국어 확장 + 불필요 WARNING 감소는 적절
  - 단, `normalize_subject()`에서 confidence 단위(0~100)에 대한 비교가 **0.7로 잘못**되어 있어 **70.0으로 수정**(의미론 갭)

- **Task 4: 통합 테스트 개선**
  - Golden Case 추가는 적절(실사용 입력 형태 반영)
  - 추가로 이번 분석에서 발견된 “커트라인 축 방향”은 기존 테스트가 못 잡고 있었으므로 sanity 테스트 보강(완료)

---

## 5) 잔존 미식별 갭(아직 남은 것) + 디벨롭안

아래는 “이번 수정으로도 남는” 리스크입니다. (엔진 한정)

### High #1 — 결격 룰의 alias 비일관성

- **현상**: 결격은 `target.university` 문자열에 regex로 적용되는데, 사용자가 “연대/고대” 등 별칭을 쓰면 룰이 누락될 수 있음
- **디벨롭안**:
  - 결격 체크 전에 대학명을 **공식명으로 정규화**(CutoffExtractor와 동일 규칙 공유)
  - 완료 기준: 별칭 입력에서도 동일한 결격 결과

### High #2 — 의대 판정 로직이 과도하게 넓음

- **현상**: `_check_medical_inquiry()`가 전공 문자열에 `"의"`가 포함되면 의대/약대 계열로 간주(예: “의류학” 오탐 가능)
- **디벨롭안**:
  - 의/약/치/한/수의 등 **명시적 키워드(정규화 후)**로 판단
  - 완료 기준: 의료계열만 과탐2과목 룰이 적용되고, 오탐 0

### Medium #1 — 컷오프/확률 결과의 “근거/폴백 플래그” 부족

- **현상**: “의예→의학” 같은 매핑/퍼지 매칭이 발생해도 결과에 근거가 명시되지 않아 사용자 신뢰/설명가능성이 낮음
- **디벨롭안**:
  - `ProgramResult` 또는 `TheoryResult.raw_components`에 다음 필드 추가:
    - `university_match_type`, `major_match_type`, `cutoff_source`, `used_alias`(bool), `used_fuzzy`(bool)
  - 완료 기준: 결과에서 “왜 이 컬럼이 선택됐는지” 추적 가능

### Medium #2 — 성능(테스트 3~4분대) / 로드 로그 과다

- **현상**: 워크북 로드 시 NULL/중복 로그가 대량 출력 + 테스트 전체가 3~4분 소요
- **디벨롭안**:
  - 워크북 로드/검증 로그를 `logging`으로 통일하고 기본 레벨에서 조용히
  - `load_workbook()` 결과를 테스트/실행에서 재사용(캐싱)
  - 완료 기준: `pytest -q` < 60초(현실적인 목표는 90초)

---

## 6) “지금 당장” 추천 실행 순서 (엔진 한정)

### P0 (즉시, 2~4시간)

1. 결격 엔진에서 대학명 정규화 적용  
2. 의료계열 판정 키워드 정교화(“의” 단일 포함 금지)  
3. 결과 객체에 매칭/폴백 플래그 추가(설명가능성)

### P1 (1~2일)

4. 커트라인/컬럼 매칭을 “정규화 토큰 기반”으로 재정렬(퍼지 단계 최소화)  
5. 실데이터 기반 Golden Case 10~20개로 확장(특히 별칭/전공/오타)

---

## 7) 변경 로그(이번 분석에서 실제 반영된 수정)

- `theory_engine/cutoff/cutoff_extractor.py`
  - `CUTOFF_PERCENTILES` 방향 수정(20/50/80)
  - Alias 역매핑 키 정규화 + 부분 매칭 제거
  - 전공 Alias 매칭을 퍼지보다 우선 + 정규화 비교로 보강

- `theory_engine/rules.py`
  - `normalize_subject()`의 confidence 비교 단위 수정(0.7 → 70.0)

- `tests/test_integration.py`
  - 커트라인 상수 테스트 업데이트
  - 커트라인 점수 방향 sanity 테스트 추가
  - 대학 Alias 오매핑 방지 sanity 테스트 추가

---

## 8) 검증 완료 기준(체크리스트)

- [x] `pytest`: 51/51 통과
- [x] PERCENTAGE 축 방향(0→상위, 값↑→하위) 실데이터 확인
- [x] 커트라인 점수 방향(적정≥예상≥소신) sanity 테스트로 고정
- [x] 대학 Alias 부분매칭 오매핑 방지(서울과기대 케이스) 테스트로 고정

---

**END**

